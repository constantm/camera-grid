server {
    listen 80;

    location / {
        root /usr/local/openresty/nginx/html;
        index index.html;
    }

    # webp proxy — fetch JPEG from go2rtc, convert to webp
    location /api/frame.webp {
        content_by_lua_block {
            local args = ngx.req.get_uri_args()
            local src = args["src"] or ""
            local width = args["width"] or ""

            -- build upstream URL
            local url = "/upstream_jpeg?src=" .. ngx.escape_uri(src)
            if width ~= "" then
                url = url .. "&width=" .. ngx.escape_uri(width)
            end

            -- fetch JPEG from go2rtc
            local res = ngx.location.capture(url)
            if res.status ~= 200 then
                ngx.status = res.status
                ngx.say("upstream error")
                return
            end

            -- convert via cwebp (stdin → stdout)
            local cwebp = io.popen("cwebp -q 55 -m 0 -quiet -o - -- -", "w")
            if not cwebp then
                -- fallback to JPEG
                ngx.header["Content-Type"] = "image/jpeg"
                ngx.print(res.body)
                return
            end

            -- use a temp file approach for reliable piping
            local tmpIn = os.tmpname()
            local tmpOut = os.tmpname() .. ".webp"
            local f = io.open(tmpIn, "wb")
            f:write(res.body)
            f:close()

            os.execute("cwebp -q 55 -m 0 -quiet " .. tmpIn .. " -o " .. tmpOut)

            local out = io.open(tmpOut, "rb")
            if out then
                local webp = out:read("*a")
                out:close()
                os.remove(tmpIn)
                os.remove(tmpOut)

                if #webp > 0 then
                    ngx.header["Content-Type"] = "image/webp"
                    ngx.header["Cache-Control"] = "no-store"
                    ngx.print(webp)
                    return
                end
            end

            os.remove(tmpIn)
            os.remove(tmpOut)
            -- fallback to JPEG
            ngx.header["Content-Type"] = "image/jpeg"
            ngx.header["Cache-Control"] = "no-store"
            ngx.print(res.body)
        }
    }

    # internal subrequest to fetch JPEG from go2rtc
    location /upstream_jpeg {
        internal;
        proxy_pass http://frigate:1984/api/frame.jpeg;
    }

    # proxy go2rtc API + websocket
    location /api/ {
        proxy_pass http://frigate:1984/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_read_timeout 86400s;
    }

    # proxy go2rtc static assets
    location /video-rtc.js {
        proxy_pass http://frigate:1984/video-rtc.js;
    }
}
